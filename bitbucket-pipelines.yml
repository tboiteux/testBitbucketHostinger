image: atlassian/default-image:2

pipelines:
  default:
    - step:
        name: "Déploiement via SSH"
        script:
          - pipe: atlassian/ssh-run:0.8.0
            variables:
              SSH_USER: $SSH_USER
              SERVER: $SSH_HOST
              COMMAND: |
                #!/usr/bin/env bash
                set -e
                
                # Se place dans le bon dossier
                cd ~/testbitbuckethostinger

                # Récupérer la dernière version
                git fetch origin main
                git reset --hard origin/main
                
                # Préparation du build Docker

                # Générer le tag de l'image
                GIT_COMMIT_SHORT=$(git rev-parse --short HEAD || echo "invalid-hash")
                DATE_TAG=$(date +%Y%m%d%H%M%S || echo "no-date")
                IMAGE_NAME=testbitbuckethostinger
                IMAGE_TAG=${DATE_TAG}-${GIT_COMMIT_SHORT}
                FULL_IMAGE=${IMAGE_NAME}:${IMAGE_TAG}

                # DEBUG : afficher les variables
                echo GIT_COMMIT_SHORT=$GIT_COMMIT_SHORT
                echo DATE_TAG=$DATE_TAG
                echo FULL_IMAGE=$FULL_IMAGE

                # Build Docker
                docker build -t $FULL_IMAGE .

                # Liste des images Docker disponibles
                docker images