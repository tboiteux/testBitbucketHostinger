image: atlassian/default-image:2

pipelines:
  default:
    - step:
        name: "Déploiement via SSH"
        script:
          - pipe: atlassian/ssh-run:0.8.0
            variables:
              SSH_USER: $SSH_USER
              SERVER: $SSH_HOST
              COMMAND: |
                #!/usr/bin/env bash
                set -e
                
                # Se place dans le bon dossier
                cd ~/testbitbuckethostinger

                # Récupérer la dernière version
                git fetch origin main
                git reset --hard origin/main
                
                # Préparation du build Docker

                # Générer le tag de l'image
                export GIT_COMMIT_SHORT=$(git rev-parse --short HEAD)
                export IMAGE_NAME="testbitbuckethostinger"
                export IMAGE_TAG="${BITBUCKET_BUILD_NUMBER}-${GIT_COMMIT_SHORT}"
                export FULL_IMAGE="${IMAGE_NAME}:${IMAGE_TAG}"

                # Build de l'image Docker locale
                docker build -t ${FULL_IMAGE} .

                # Liste des images Docker disponibles
                docker images